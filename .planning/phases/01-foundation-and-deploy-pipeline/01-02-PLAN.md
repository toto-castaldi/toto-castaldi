---
phase: 01-foundation-and-deploy-pipeline
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified: []
autonomous: false
requirements:
  - INFR-02

must_haves:
  truths:
    - "Pushing to main triggers GitHub Actions and deploys successfully to GitHub Pages"
    - "https://toto-castaldi.com loads a page served by GitHub Pages with valid HTTPS"
    - "https://www.toto-castaldi.com redirects to or serves the same site"
    - "The deployed site has /it/ and /en/ paths rendering correct language content"
    - "Custom domain persists after a second push/deploy cycle"
  artifacts: []
  key_links:
    - from: ".github/workflows/hugo.yaml"
      to: "GitHub Pages deployment"
      via: "actions/deploy-pages@v4 artifact upload"
      pattern: "deploy-pages"
    - from: "static/CNAME"
      to: "GitHub Pages custom domain"
      via: "CNAME file in build output root"
      pattern: "toto-castaldi.com"
---

<objective>
Configure GitHub Pages deployment source, set custom domain, update DNS records, and verify the live site serves bilingual content over HTTPS.

Purpose: Complete the deployment pipeline and custom domain setup so the site is live and accessible at toto-castaldi.com with HTTPS.

Output: A live, deployed bilingual site at toto-castaldi.com with working HTTPS and stable custom domain.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-deploy-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-and-deploy-pipeline/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure GitHub Pages source and trigger first deployment</name>
  <files></files>
  <action>
    Use the GitHub CLI (`gh`) to configure the repository for GitHub Pages deployment:

    1. Set GitHub Pages source to "GitHub Actions":
       ```bash
       gh api repos/toto-castaldi/toto-castaldi/pages \
         --method POST \
         --field build_type=workflow \
         -H "Accept: application/vnd.github+json" 2>/dev/null || \
       gh api repos/toto-castaldi/toto-castaldi/pages \
         --method PUT \
         --field build_type=workflow \
         -H "Accept: application/vnd.github+json"
       ```
       (POST creates if not exists, PUT updates if already configured)

    2. Set custom domain to toto-castaldi.com:
       ```bash
       gh api repos/toto-castaldi/toto-castaldi/pages \
         --method PUT \
         --field cname=toto-castaldi.com \
         -H "Accept: application/vnd.github+json"
       ```
       IMPORTANT: Set custom domain in GitHub Settings BEFORE updating DNS records (prevents domain takeover window).

    3. Push the code from Plan 01 to main to trigger the first GitHub Actions build. If the code was already committed but not pushed, push it now. Verify the workflow runs:
       ```bash
       gh run list --workflow=hugo.yaml --limit=1
       ```
       Wait for it to complete:
       ```bash
       gh run watch $(gh run list --workflow=hugo.yaml --limit=1 --json databaseId --jq '.[0].databaseId')
       ```

    4. After successful deployment, verify the GitHub Pages URL works:
       ```bash
       gh api repos/toto-castaldi/toto-castaldi/pages --jq '.html_url'
       ```

    If the `gh api` commands fail due to permissions, create a checkpoint for the user to manually configure GitHub Pages source to "GitHub Actions" in repo Settings > Pages.
  </action>
  <verify>
    1. `gh api repos/toto-castaldi/toto-castaldi/pages --jq '.build_type'` returns "workflow"
    2. `gh api repos/toto-castaldi/toto-castaldi/pages --jq '.cname'` returns "toto-castaldi.com"
    3. `gh run list --workflow=hugo.yaml --limit=1` shows a completed (success) run
  </verify>
  <done>GitHub Pages is configured with "GitHub Actions" source and custom domain set to toto-castaldi.com. First deployment completed successfully.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User configures DNS records for custom domain</name>
  <files></files>
  <action>
    This is a human-only action. Claude cannot access DNS provider dashboards.

    GitHub Pages is configured and the site deploys via GitHub Actions. The custom domain is set to toto-castaldi.com in GitHub Settings. Now DNS records must be updated to point the domain to GitHub Pages servers.

    The user needs to update DNS records at their DNS provider. The exact steps depend on which provider manages toto-castaldi.com (Cloudflare, Route53, registrar DNS panel, etc.).

    **Before changing records:**
    - Note/screenshot existing DNS records for the apex domain and www
    - Do NOT touch subdomain records for docora, lumio, or helix

    **Records to REMOVE (old hosting):**
    - Any existing A records for `@` (apex) pointing to the old host
    - Any existing CNAME for `www` pointing to the old host
    - Any wildcard record (`*`) if present (GitHub warns this creates domain takeover risk)

    **Records to ADD:**

    | Type | Name | Value |
    |------|------|-------|
    | A | @ | 185.199.108.153 |
    | A | @ | 185.199.109.153 |
    | A | @ | 185.199.110.153 |
    | A | @ | 185.199.111.153 |
    | CNAME | www | toto-castaldi.github.io |

    **Optional IPv6 (recommended):**

    | Type | Name | Value |
    |------|------|-------|
    | AAAA | @ | 2606:50c0:8000::153 |
    | AAAA | @ | 2606:50c0:8001::153 |
    | AAAA | @ | 2606:50c0:8002::153 |
    | AAAA | @ | 2606:50c0:8003::153 |

    **After adding records:**
    - Wait for DNS propagation (can take up to 24 hours, often much faster)
    - Verify with: `dig toto-castaldi.com +short` (should show the 4 GitHub IPs)
    - Verify with: `dig www.toto-castaldi.com +short` (should show toto-castaldi.github.io)

    **Brief downtime is expected** during DNS cutover from the current host. This was acknowledged as acceptable.

    Resume signal: Type "DNS updated" when records are configured, or share your DNS provider if you need more specific guidance.
  </action>
  <verify>
    `dig toto-castaldi.com +short` returns GitHub Pages IPs (185.199.108-111.153) and `dig www.toto-castaldi.com +short` returns toto-castaldi.github.io.
  </verify>
  <done>DNS records point toto-castaldi.com and www.toto-castaldi.com to GitHub Pages servers.</done>
</task>

<task type="auto">
  <name>Task 3: Verify HTTPS enforcement and full deployment</name>
  <files></files>
  <action>
    After the user confirms DNS records are updated:

    1. Check DNS propagation:
       ```bash
       dig toto-castaldi.com +short
       dig www.toto-castaldi.com +short
       ```
       Expected: 4 GitHub Pages IPs for apex, toto-castaldi.github.io for www.

    2. Check GitHub Pages status and HTTPS:
       ```bash
       gh api repos/toto-castaldi/toto-castaldi/pages --jq '{url: .html_url, https: .https_enforced, cname: .cname, status: .status}'
       ```

    3. If HTTPS is not yet enforced and DNS has propagated, enable it:
       ```bash
       gh api repos/toto-castaldi/toto-castaldi/pages \
         --method PUT \
         --field https_enforced=true \
         -H "Accept: application/vnd.github+json"
       ```
       Note: This may fail if the Let's Encrypt certificate hasn't been provisioned yet. Wait and retry.

    4. Verify the live site serves correct content:
       ```bash
       curl -sL https://toto-castaldi.com | grep -o 'meta.*refresh.*content'
       curl -sL https://toto-castaldi.com/it/ | grep "Antonio Toto Castaldi"
       curl -sL https://toto-castaldi.com/en/ | grep "Antonio Toto Castaldi"
       curl -sL https://www.toto-castaldi.com | head -5
       ```

    5. Verify 404 page works:
       ```bash
       curl -sL https://toto-castaldi.com/nonexistent | grep "Pagina non trovata"
       ```

    6. Verify CNAME persists by triggering a second deploy (make a trivial commit or use `gh workflow run`):
       ```bash
       gh api repos/toto-castaldi/toto-castaldi/pages --jq '.cname'
       ```
       Should still be "toto-castaldi.com" after the second deploy.

    If DNS hasn't propagated yet, inform the user to wait and retry later. HTTPS certificate provisioning can take up to 1 hour after DNS propagation.
  </action>
  <verify>
    1. `curl -sI https://toto-castaldi.com` returns HTTP 200 or 301 redirect
    2. `curl -sL https://toto-castaldi.com/it/` contains "Antonio Toto Castaldi"
    3. `curl -sL https://toto-castaldi.com/en/` contains "Antonio Toto Castaldi"
    4. `curl -sI https://www.toto-castaldi.com` returns HTTP 200 or 301
    5. `gh api repos/toto-castaldi/toto-castaldi/pages --jq '.https_enforced'` returns true
  </verify>
  <done>Site is live at https://toto-castaldi.com with valid HTTPS, /it/ and /en/ paths render correct content, www redirects work, 404 page is bilingual, and custom domain persists across deploys.</done>
</task>

</tasks>

<verification>
**Phase 1 Success Criteria (from ROADMAP.md):**
1. Visiting https://toto-castaldi.com loads a page served by GitHub Pages with a valid HTTPS certificate
   - Verify: `curl -sI https://toto-castaldi.com` shows `server: GitHub.com` or 200 status
2. Visiting https://www.toto-castaldi.com redirects to or serves the same site
   - Verify: `curl -sIL https://www.toto-castaldi.com` reaches same content
3. The site has distinct /it/ and /en/ URL paths that each render a page in the correct language
   - Verify: `curl -sL https://toto-castaldi.com/it/` shows Italian, `/en/` shows English
4. Pushing to main branch triggers GitHub Actions and deploys automatically without losing the custom domain
   - Verify: `gh run list --workflow=hugo.yaml` shows successful runs; `gh api .../pages --jq '.cname'` still shows toto-castaldi.com after multiple deploys
</verification>

<success_criteria>
- GitHub Pages deployment triggered by push to main
- Custom domain toto-castaldi.com active with HTTPS
- www.toto-castaldi.com works (redirect or serve)
- /it/ and /en/ paths serve correct language content
- Custom domain persists across multiple deploy cycles
- 404 page shows bilingual content
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-deploy-pipeline/01-02-SUMMARY.md`
</output>
