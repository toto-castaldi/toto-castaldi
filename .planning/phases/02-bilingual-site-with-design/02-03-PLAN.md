---
phase: 02-bilingual-site-with-design
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/css/main.css
  - layouts/_default/baseof.html
  - i18n/en.toml
  - i18n/it.toml
autonomous: true
gap_closure: true
requirements: [DSGN-02, UI-04]

must_haves:
  truths:
    - "A visible toggle control exists on the page that switches between light and dark color schemes"
    - "Clicking the toggle changes all page colors (background, text, cards, borders) without JavaScript"
    - "On first load with no toggle interaction, the page respects OS prefers-color-scheme preference"
    - "Zero JavaScript in rendered HTML output — the toggle uses CSS-only checkbox technique"
  artifacts:
    - path: "assets/css/main.css"
      provides: "CSS-only dark mode toggle using checkbox :checked state, with prefers-color-scheme as initial default"
      contains: "#dark-toggle:checked"
    - path: "layouts/_default/baseof.html"
      provides: "Hidden checkbox input and visible label for dark mode toggle"
      contains: "dark-toggle"
    - path: "i18n/en.toml"
      provides: "English label for dark mode toggle"
      contains: "darkModeToggle"
    - path: "i18n/it.toml"
      provides: "Italian label for dark mode toggle"
      contains: "darkModeToggle"
  key_links:
    - from: "layouts/_default/baseof.html"
      to: "assets/css/main.css"
      via: "checkbox #dark-toggle controls CSS variable overrides through :checked + .page-wrapper selector"
      pattern: "#dark-toggle.*page-wrapper"
---

<objective>
Add a CSS-only dark mode toggle switch to the page header, replacing the OS-only prefers-color-scheme behavior with a manual user control.

Purpose: Users requested the ability to manually switch between light and dark modes via a visible toggle in the UI, rather than relying solely on OS preference. The toggle must use a CSS-only hidden checkbox technique to preserve the zero-JavaScript requirement (UI-04).

Output: Modified baseof.html with toggle markup, reworked CSS with checkbox-driven dark mode, updated i18n files with toggle accessibility labels.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bilingual-site-with-design/02-01-SUMMARY.md
@.planning/phases/02-bilingual-site-with-design/02-02-SUMMARY.md
@assets/css/main.css
@layouts/_default/baseof.html
@i18n/en.toml
@i18n/it.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dark mode toggle markup and restructure baseof.html</name>
  <files>
    layouts/_default/baseof.html
    i18n/en.toml
    i18n/it.toml
  </files>
  <action>
Modify `layouts/_default/baseof.html` to add the CSS-only dark mode toggle:

1. Add a hidden checkbox `<input type="checkbox" id="dark-toggle" class="sr-only">` as the FIRST child of `<body>`, before any other elements.
2. Wrap ALL existing body content (`<header>` and `<main>`) inside a `<div class="page-wrapper">`. This wrapper is required so the CSS adjacent sibling selector `#dark-toggle:checked + .page-wrapper` can override color tokens.
3. Inside `<header class="site-header">`, add a `<label for="dark-toggle" class="dark-toggle-btn" role="button" aria-label="{{ T "darkModeToggle" }}">` element. Place it BEFORE the `<nav>` element. The label contains two spans:
   - `<span class="toggle-icon toggle-icon--light" aria-hidden="true">&#9788;</span>` (sun symbol ☼, U+263C, visible in light mode)
   - `<span class="toggle-icon toggle-icon--dark" aria-hidden="true">&#9790;</span>` (moon symbol ☾, U+263E, visible in dark mode)
4. The `<label>` is the visible toggle button. Clicking it checks/unchecks the hidden checkbox, which drives the CSS dark mode switch. No JavaScript needed.

The resulting baseof.html structure:
```
<body>
  <input type="checkbox" id="dark-toggle" class="sr-only">
  <div class="page-wrapper">
    <header class="site-header">
      <label for="dark-toggle" ...>...</label>
      <nav ...>...</nav>
    </header>
    <main>
      {{ block "main" . }}{{ end }}
    </main>
  </div>
</body>
```

Also add i18n strings to both files:

In `i18n/en.toml`, add:
```toml
[darkModeToggle]
other = "Toggle dark mode"
```

In `i18n/it.toml`, add:
```toml
[darkModeToggle]
other = "Attiva/disattiva tema scuro"
```
  </action>
  <verify>
Run `hugo --minify` and confirm:
1. Build succeeds with no errors
2. Rendered `public/it/index.html` contains `id="dark-toggle"` checkbox, `class="page-wrapper"` div, and `<label for="dark-toggle"` element
3. Rendered HTML contains zero `<script>` tags (grep for `<script` in public/)
4. Both i18n files contain `darkModeToggle` key
  </verify>
  <done>baseof.html has hidden checkbox as first body child, page-wrapper div enclosing all content, and a visible label toggle in the header with sun/moon icons. i18n files have toggle labels in both languages. Zero JavaScript in output.</done>
</task>

<task type="auto">
  <name>Task 2: Rework CSS dark mode from media-query-only to checkbox-driven with OS default</name>
  <files>
    assets/css/main.css
  </files>
  <action>
Rework the dark mode CSS in `assets/css/main.css` to use the checkbox toggle pattern while preserving OS preference as the initial default.

**Step 1: Keep `:root` light mode tokens exactly as they are** (lines 17-48). No changes.

**Step 2: Move the existing `@media (prefers-color-scheme: dark) :root` block** (lines 53-63) to target `.page-wrapper` instead of `:root`:

```css
@media (prefers-color-scheme: dark) {
  .page-wrapper {
    --color-bg: #111827;
    --color-text: #f3f4f6;
    --color-text-muted: #9ca3af;
    --color-border: #374151;
    --color-link: #60a5fa;
    --color-link-hover: #93bbfd;
    --color-card-bg: #1f2937;
  }
}
```

**Step 3: Add checkbox toggle override — when user is in light OS mode and clicks toggle, go dark:**

```css
#dark-toggle:checked + .page-wrapper {
  --color-bg: #111827;
  --color-text: #f3f4f6;
  --color-text-muted: #9ca3af;
  --color-border: #374151;
  --color-link: #60a5fa;
  --color-link-hover: #93bbfd;
  --color-card-bg: #1f2937;
}
```

**Step 4: Add reverse toggle — when user is in dark OS mode and clicks toggle, go light:**

```css
@media (prefers-color-scheme: dark) {
  #dark-toggle:checked + .page-wrapper {
    --color-bg: #ffffff;
    --color-text: #1a1a1a;
    --color-text-muted: #6b7280;
    --color-border: #e5e7eb;
    --color-link: #2563eb;
    --color-link-hover: #1d4ed8;
    --color-card-bg: #ffffff;
  }
}
```

**Step 5: Add `.page-wrapper` base styles.** Move `background` and `color` from `body` to `.page-wrapper` so the wrapper inherits the toggled custom property values:

```css
.page-wrapper {
  color: var(--color-text);
  background: var(--color-bg);
  min-height: 100vh;
}
```

Keep `body` styles (font-family, font-size, line-height, max-width, margin, padding) BUT move `color` and `background` to `.page-wrapper`. Also set `background: var(--color-bg)` on `body` as well (fallback for the area outside the wrapper, if any) but the primary theming lives on `.page-wrapper`.

Actually, since `body` has `max-width: 680px` and `margin: 0 auto`, the page-wrapper needs to handle the full-viewport background. Restructure:

- `body`: keep `font-family`, `font-size`, `line-height`, `margin: 0`, `padding: 0`. Set `background: var(--color-bg)` as a base fallback.
- `.page-wrapper`: add `max-width: var(--max-width)`, `margin: 0 auto`, `padding: var(--space-xl) var(--space-md)`, `color: var(--color-text)`, `background: var(--color-bg)`, `min-height: 100vh`.

This moves the layout centering from `body` to `.page-wrapper` so the background color change from the toggle covers the full viewport via `body` fallback while the wrapper handles content centering.

Wait — for full-viewport background coverage, `body` needs to also respond to the toggle. Since `.page-wrapper` is a child of `body` and CSS custom properties on `.page-wrapper` don't cascade UP to `body`, we need a different approach for the body background.

**Revised approach for full-viewport background:**

- `body`: set `background: var(--color-bg)` using `:root` tokens (covers light mode)
- Add `body:has(#dark-toggle:checked)` — NO, we want to avoid `:has()` for max compatibility with the sibling selector approach.

**Simplest solution:** Make `.page-wrapper` cover the full viewport with `min-height: 100vh` and its own background. The `body` background behind it is irrelevant since the wrapper covers everything. Remove `max-width` from `body`, put it on a child element or keep centering on `.page-wrapper`.

```css
body {
  font-family: system-ui, -apple-system, sans-serif;
  font-size: var(--font-size-base);
  line-height: var(--line-height-body);
  color: var(--color-text);
  background: var(--color-bg);
  margin: 0;
  padding: 0;
}

.page-wrapper {
  max-width: var(--max-width);
  margin: 0 auto;
  padding: var(--space-xl) var(--space-md);
  color: var(--color-text);
  background: var(--color-bg);
  min-height: 100vh;
}
```

The `body` will use `:root` light tokens by default and the `@media (prefers-color-scheme: dark) :root` override for OS dark mode. The `.page-wrapper` re-reads the same vars BUT can be overridden by the checkbox selectors. Since `.page-wrapper` has `min-height: 100vh`, it always covers the viewport. Any `body` background peeking through will match because `body` reads from `:root` which matches the OS preference — and the only mismatch case is when the toggle is active. For that edge case, set `background: inherit` on `body`... No, that's circular.

**Final clean approach:**

Keep `:root` with light tokens. Keep `@media (prefers-color-scheme: dark) :root` with dark tokens. `body` reads from `:root` — this handles the OS preference. `.page-wrapper` also reads from the same vars by default. The checkbox selectors on `.page-wrapper` override the vars. To handle the body background for the full viewport, give `.page-wrapper` `min-height: 100vh` and `width: 100%` so it completely covers the body. Set `body { margin: 0; padding: 0; overflow-x: hidden; }`. The `.page-wrapper` handles ALL visual theming, layout centering (`max-width` + `margin: 0 auto`), and padding.

This way, even if `body` shows the `:root` (OS-based) background, it's fully covered by `.page-wrapper` which responds to the toggle.

Implement this approach. The complete body and page-wrapper styles:

```css
body {
  font-family: system-ui, -apple-system, sans-serif;
  font-size: var(--font-size-base);
  line-height: var(--line-height-body);
  margin: 0;
  padding: 0;
}

.page-wrapper {
  max-width: var(--max-width);
  margin: 0 auto;
  padding: var(--space-xl) var(--space-md);
  color: var(--color-text);
  background: var(--color-bg);
  min-height: 100vh;
}
```

**Step 6: Add toggle button styles:**

```css
/* Dark Mode Toggle Button */
.dark-toggle-btn {
  cursor: pointer;
  font-size: var(--font-size-md);
  color: var(--color-text-muted);
  line-height: 1;
  display: flex;
  align-items: center;
  padding: var(--space-xs);
  border-radius: 0.25rem;
  transition: color 0.15s ease;
}

.dark-toggle-btn:hover {
  color: var(--color-text);
}
```

**Step 7: Add icon visibility toggling** — show sun in light mode, moon in dark mode:

```css
/* Light mode: show sun, hide moon */
.toggle-icon--dark { display: none; }
.toggle-icon--light { display: inline; }

/* OS dark mode: show moon, hide sun */
@media (prefers-color-scheme: dark) {
  .toggle-icon--dark { display: inline; }
  .toggle-icon--light { display: none; }
}

/* Toggle checked in light OS: show moon (now dark) */
#dark-toggle:checked + .page-wrapper .toggle-icon--dark { display: inline; }
#dark-toggle:checked + .page-wrapper .toggle-icon--light { display: none; }

/* Toggle checked in dark OS: show sun (now light) */
@media (prefers-color-scheme: dark) {
  #dark-toggle:checked + .page-wrapper .toggle-icon--dark { display: none; }
  #dark-toggle:checked + .page-wrapper .toggle-icon--light { display: inline; }
}
```

**Step 8: Update `.site-header`** to accommodate the toggle and language switcher with space-between:

```css
.site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: var(--space-lg);
}
```

This puts the toggle on the left and language switcher on the right (or vice versa). Since the user context says language switcher is top-right, put the dark mode toggle on the left side of the header. The `space-between` layout handles this naturally: toggle (first child) goes left, nav (second child) goes right.

**Important:** Do NOT use any JavaScript. Do NOT use `:has()` — rely only on `#dark-toggle:checked + .page-wrapper` sibling combinator which has universal browser support.

**Important:** The `.sr-only` class on the hidden checkbox ensures it is invisible but still accessible to screen readers and still participates in the `:checked` CSS selector because it uses `position: absolute` clipping, not `display: none`.
  </action>
  <verify>
Run `hugo --minify` and confirm:
1. Build succeeds
2. Grep rendered HTML for `<script` — must find zero matches
3. Inspect CSS output for `#dark-toggle:checked` selectors
4. Inspect CSS for both `prefers-color-scheme: dark` media query blocks (OS default and toggle-reverse)
5. Confirm `.page-wrapper` has `min-height: 100vh` and `background: var(--color-bg)` in output CSS
6. Run `hugo server -D` and test: page loads in light mode with OS light preference; clicking the sun/moon label toggles to dark mode; all colors change (background, text, cards, borders); clicking again returns to light mode
  </verify>
  <done>CSS uses checkbox-driven dark mode toggle with four states: (1) OS-light default shows light theme, (2) OS-dark default shows dark theme, (3) toggle checked in OS-light shows dark theme, (4) toggle checked in OS-dark shows light theme. Sun icon shows in light state, moon icon shows in dark state. Zero JavaScript. All WCAG AA color pairs preserved in both modes.</done>
</task>

</tasks>

<verification>
1. `hugo --minify` builds with no errors
2. `grep -r '<script' public/` returns zero matches (UI-04: zero JavaScript)
3. Rendered HTML contains `<input type="checkbox" id="dark-toggle"` and `<label for="dark-toggle"`
4. CSS contains `#dark-toggle:checked + .page-wrapper` selectors for both light-to-dark and dark-to-light overrides
5. CSS contains `@media (prefers-color-scheme: dark)` for OS default and reverse toggle
6. Toggle icon visibility switches correctly (sun in light state, moon in dark state)
7. `.page-wrapper` covers full viewport (`min-height: 100vh`) so toggled background color is seamless
</verification>

<success_criteria>
- A visible toggle control (sun/moon icon) appears in the page header
- Clicking the toggle switches between light and dark color schemes with no page reload and no JavaScript
- The page still respects OS dark mode preference on first load (before any toggle interaction)
- All existing WCAG AA color pairs are preserved in both light and dark states
- Zero `<script>` tags in rendered HTML output
- Hugo builds cleanly with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-bilingual-site-with-design/02-03-SUMMARY.md`
</output>
